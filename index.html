<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Minecraft Map</title>
    <link rel="icon" type="image/png" href="creeper.png">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: #2a2a2a;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            text-align: center;
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .map-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            border: 3px solid #666;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
        }
        
        .map-image {
            display: block;
            max-width: 900px;
            width: 100%;
            height: auto;
        }
        
        .marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #ff4444;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .marker:hover {
            background: #ff6666;
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.6);
        }
        
        .marker.active {
            background: #44ff44;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(68, 255, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(68, 255, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(68, 255, 68, 0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: relative;
            margin: 5% auto;
            max-width: 80%;
            max-height: 80%;
            background: #333;
            border-radius: 12px;
            overflow: auto;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .modal-image {
            max-width: 100%;
            max-height: 50vh;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            margin: 0 auto 16px auto;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #ff4444;
        }
        
        .coordinates {
            background: rgba(0,0,0,0.7);
            color: #4CAF50;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            display: inline-block;
        }
        
        .controls {
            margin: 20px 0 36px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .btn {
            background: #256029;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #19451a;
        }
        
        .info {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            padding: 18px 24px 18px 24px;
            background: #333;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            min-height: 56px;
            flex-shrink: 0;
        }
        .btn-danger {
            background: #ff4444;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 0;
            transition: background 0.3s;
        }
        .btn-danger:hover {
            background: #ff2222;
        }
        .btn-edit {
            background: #4CAF50;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .btn-edit:hover {
            background: #388e3c;
        }
        /* 個別ボタン色 */
        .btn-origin, .btn-marker-add, .btn-marker-clear {
            background: #4CAF50 !important;
        }
        .btn-origin:hover, .btn-marker-add:hover, .btn-marker-clear:hover {
            background: #45a049 !important;
        }
        .btn-addmode-active {
            background: #ff4444 !important;
            color: #fff !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><img src="creeper.png" alt="Minecraft Map" style="width: 32px; height: auto; padding-right: 12px; position: relative; top: 4px;">My Minecraft Map</h1>
        
        <!--
        <div class="info">
            <strong style="cursor:pointer;" onclick="toggleInfo()">
                使い方 <span id="infoToggleIcon">▼</span>
            </strong>
            <ul id="infoList" style="display:none;">
                <li>最初に原点を設定してください</li>
                <li>赤いマーカーをクリックすると、その座標での写真が表示されます</li>
                <li>「マーカーを追加」ボタンでマップをクリックして新しいマーカーを追加できます</li>
                <li>マーカーの座標は自動的に計算されます</li>
            </ul>
        </div>
        -->
        
        <div style="margin-bottom: 18px; display: flex; align-items: center; gap: 10px;">
            <label style="color:#fff;">マップ枚数: </label>
            <input type="number" id="mapCols" value="3" min="1" max="10" style="width:48px;"> ×
            <input type="number" id="mapRows" value="3" min="1" max="10" style="width:48px;">
            <button class="btn" onclick="applyMapGrid()">設定</button>
            <label for="mapImageUpload" class="btn" style="margin-left:10px;cursor:pointer;background:#256029;">upload マップ
                <input type="file" id="mapImageUpload" accept="image/*" style="display:none;">
            </label>
        </div>
        
        <div class="controls">
            <button class="btn btn-origin" type="button" id="originBtn">🎯 原点を設定</button>
            <button class="btn btn-marker-add" type="button">📍 マーカーを追加</button>
            <button class="btn btn-marker-clear" type="button">🗑️ マーカーをクリア</button>
        </div>
        
        <div class="map-container" id="mapContainer">
            <!-- デモ用のマップ画像 - 実際の画像に置き換えてください -->
            <img src="worldmap.png" 
                 class="map-image" 
                 id="mapImage" 
                 alt="Minecraft Map">
            <div id="markerCards" style="position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:30;"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <span id="modalTitle">座標での写真</span>
            </div>
            <div class="modal-body">
                <div class="coordinates" id="modalCoordinates"></div>
                <br>
                <img id="modalImage" class="modal-image" alt="Location Photo">
                <div id="modalMemo"></div>
            </div>
            <!-- フッターはJSで生成 -->
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, serverTimestamp, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
      import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

      // Firebase設定
      const firebaseConfig = {
        apiKey: "AIzaSyBQPxpSrBaVBXMVnv9bZ_ts-be68xxSqmU",
        authDomain: "mymcmap-21477.firebaseapp.com",
        projectId: "mymcmap-21477",
        storageBucket: "mymcmap-21477.firebasestorage.app",
        messagingSenderId: "540082815973",
        appId: "1:540082815973:web:dde0c098afe328e8b9650c"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // 画像圧縮関数
      async function compressImage(file, maxWidth = 800, quality = 0.7) {
        return new Promise((resolve) => {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = (e) => { img.src = e.target.result; };
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(
              (blob) => { resolve(blob); },
              'image/jpeg',
              quality
            );
          };
          reader.readAsDataURL(file);
        });
      }

      // Firestoreにマーカー追加
      async function saveMarkerToFirebase(markerData, imageFile) {
        let imageUrl = '';
        if (imageFile) {
          const compressedBlob = await compressImage(imageFile, 800, 0.7);
          const imgRef = storageRef(storage, 'markerImages/' + Date.now() + '_' + imageFile.name);
          await uploadBytes(imgRef, compressedBlob);
          imageUrl = await getDownloadURL(imgRef);
        } else if (markerData.imageUrl) {
          imageUrl = markerData.imageUrl;
        }
        const docRef = await addDoc(collection(db, 'markers'), {
          ...markerData,
          imageUrl,
          createdAt: serverTimestamp()
        });
        return docRef.id;
      }

      // Firestoreからマーカー一覧取得
      async function loadMarkersFromFirebase() {
        const q = query(collection(db, 'markers'), orderBy('createdAt'));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }

      // Firestoreのマーカーを更新
      async function updateMarkerInFirebase(id, markerData, imageFile) {
        let imageUrl = markerData.imageUrl || '';
        if (imageFile) {
          const compressedBlob = await compressImage(imageFile, 800, 0.7);
          const imgRef = storageRef(storage, 'markerImages/' + Date.now() + '_' + imageFile.name);
          await uploadBytes(imgRef, compressedBlob);
          imageUrl = await getDownloadURL(imgRef);
        }
        await updateDoc(doc(db, 'markers', id), {
          ...markerData,
          imageUrl
        });
      }

      // Firestoreのマーカーを全てマップに表示
      async function renderAllMarkers() {
        // 既存マーカーを全削除
        document.querySelectorAll('.marker').forEach(m => m.remove());
        const markers = await loadMarkersFromFirebase();
        console.log('markers:', markers);
        markers.forEach(markerObj => {
          addMarkerCustom(
            markerObj.x, markerObj.y, markerObj.z,
            markerObj.title, markerObj.imageUrl, markerObj.color, markerObj.memo, markerObj.id
          );
        });
      }

      // ここから下は元のアプリ本体のJS

      let markers = [];
      let addMode = false;
      let originMode = false;
      let mapContainer = document.getElementById('mapContainer');
      let mapImage = document.getElementById('mapImage');
      let originPxX = null;
      let originPxY = null;
      // マップ分割数
      let mapCols = parseInt(localStorage.getItem('mapCols')) || 3;
      let mapRows = parseInt(localStorage.getItem('mapRows')) || 3;
      // 1枚のマップのブロック数
      const mapBlockSize = 2048;
      // 1ピクセル=16ブロック
      const pxPerBlock = 1 / 16;
      // 全体のブロック数
      function getTotalBlocksX() { return mapCols * mapBlockSize; }
      function getTotalBlocksY() { return mapRows * mapBlockSize; }
      // マップ分割数UIに反映
      document.getElementById('mapCols').value = mapCols;
      document.getElementById('mapRows').value = mapRows;

      // 原点をFirestoreに保存
      async function saveOriginToFirestore(x, y) {
        try {
          await setDoc(doc(db, 'settings', 'origin'), { originPxX: x, originPxY: y });
          console.log('Origin saved to Firestore:', x, y);
        } catch (e) {
          console.error('Firestore save error:', e);
          throw e;
        }
      }
      // Firestoreから原点を取得
      async function loadOriginFromFirebase() {
        const docSnap = await getDoc(doc(db, 'settings', 'origin'));
        if (docSnap.exists()) {
          return docSnap.data();
        } else {
          return null;
        }
      }

      // デモ用のマーカーデータ
      const demoMarkers = [];
      
      // マーカーごとに一意のIDを付与
      let markerIdSeq = 0;
      
      // 初期化
      function init() {
          // デモマーカーなし
          // マップ分割数UI初期化
          document.getElementById('mapCols').value = mapCols;
          document.getElementById('mapRows').value = mapRows;
          // マップクリックイベント
          mapContainer.addEventListener('click', async function(e) {
              const rect = mapContainer.getBoundingClientRect();
              const x = e.clientX - rect.left;
              const y = e.clientY - rect.top;
              if (originMode) {
                  originPxX = x;
                  originPxY = y;
                  console.log('Try to save origin:', originPxX, originPxY);
                  saveOriginToFirestore(originPxX, originPxY)
                    .then(() => {
                      alert(`原点を設定しました: (${originPxX.toFixed(1)}, ${originPxY.toFixed(1)})`);
                      toggleOriginMode();
                    })
                    .catch(e => {
                      console.error('Failed to save origin:', e);
                      alert('原点の保存に失敗しました');
                    });
                  return;
              }
              if (addMode) {
                  const imgW = mapImage.clientWidth;
                  const imgH = mapImage.clientHeight;
                  if (originPxX === null || originPxY === null) {
                      alert('まず原点を設定してください');
                      return;
                  }
                  // 原点を基準にピクセル→マイクラ座標
                  const mx0 = Math.round(((x - originPxX) / imgW) * getTotalBlocksX());
                  const mz0 = Math.round(((y - originPxY) / imgH) * getTotalBlocksY());
                  const my0 = 64;
                  showAddMarkerDialog(mx0, my0, mz0, x, y);
              }
          });
      }
      
      // マーカー追加用カスタムダイアログ
      function showAddMarkerDialog(mx0, my0, mz0, pxX, pxY) {
          // 色候補
          const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff', '#44ffff', '#ff8800', '#888888'];
          // ダイアログHTML
          const dialog = document.createElement('div');
          dialog.style.position = 'fixed';
          dialog.style.left = '0';
          dialog.style.top = '0';
          dialog.style.width = '100vw';
          dialog.style.height = '100vh';
          dialog.style.background = 'rgba(0,0,0,0.7)';
          dialog.style.zIndex = '2000';
          dialog.style.display = 'flex';
          dialog.style.alignItems = 'center';
          dialog.style.justifyContent = 'center';
          dialog.innerHTML = `
              <div style="background:#222;padding:24px 32px;border-radius:12px;min-width:320px;max-width:90vw;box-shadow:0 0 24px #000;position:relative;">
                  <button id="closeAddMarker" style="position:absolute;top:8px;right:12px;font-size:20px;background:none;border:none;color:#fff;cursor:pointer;">&times;</button>
                  <h2 style="color:#4CAF50;margin-top:0;">マーカー追加</h2>
                  <label style="color:#fff;">座標 (x, y, z):<br>
                      <input id="markerX" type="number" value="${mx0}" style="width:70px;"> ,
                      <input id="markerY" type="number" value="${my0}" style="width:70px;"> ,
                      <input id="markerZ" type="number" value="${mz0}" style="width:70px;">
                  </label><br><br>
                  <label style="color:#fff;">タイトル:<br>
                      <input id="markerTitle" type="text" value="新しい場所" style="width:90%;">
                  </label><br><br>
                  <label style="color:#fff;">メモ:<br>
                      <textarea id="markerMemo" rows="2" style="width:90%;resize:vertical;"></textarea>
                  </label><br><br>
                  <label style="color:#fff;">upload マップ:<br>
                      <input id="markerImage" type="file" accept="image/*">
                  </label><br><br>
                  <label style="color:#fff;">マーカー色:<br>
                      <div id="colorChoices" style="display:flex;gap:8px;margin-top:4px;">
                          ${colors.map((c,i)=>`<div class="color-choice" data-color="${c}" style="width:28px;height:28px;border-radius:50%;background:${c};border:3px solid #fff;cursor:pointer;box-shadow:0 2px 8px #000;${i===0?'outline:2px solid #4CAF50;':''}"></div>`).join('')}
                      </div>
                  </label><br>
                  <button id="addMarkerBtn" class="btn" style="margin-top:10px;">追加</button>
              </div>
          `;
          document.body.appendChild(dialog);
          let selectedColor = colors[0];
          // 色選択
          dialog.querySelectorAll('.color-choice').forEach(el => {
              el.onclick = function() {
                  dialog.querySelectorAll('.color-choice').forEach(e=>e.style.outline='none');
                  this.style.outline = '2px solid #4CAF50';
                  selectedColor = this.getAttribute('data-color');
              };
          });
          // 閉じる
          dialog.querySelector('#closeAddMarker').onclick = ()=>dialog.remove();
          // 追加ボタン
          dialog.querySelector('#addMarkerBtn').onclick = async function() {
              const mx = parseInt(dialog.querySelector('#markerX').value);
              const my = parseInt(dialog.querySelector('#markerY').value);
              const mz = parseInt(dialog.querySelector('#markerZ').value);
              const title = dialog.querySelector('#markerTitle').value;
              const memo = dialog.querySelector('#markerMemo').value;
              const fileInput = dialog.querySelector('#markerImage');
              if (isNaN(mx) || isNaN(my) || isNaN(mz)) { alert('座標が正しくありません'); return; }
              if (!title) { alert('タイトルを入力してください'); return; }
              let imageFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
              const markerData = { x: mx, y: my, z: mz, title, memo, color: selectedColor };
              await window.saveMarkerToFirebase(markerData, imageFile);
              dialog.remove();
              window.renderAllMarkers();
          };
      }
      
      // カスタムマーカー追加
      function addMarkerCustom(mx, my, mz, title, imageUrl, color, memo, firebaseId) {
          const imgW = mapImage.clientWidth;
          const imgH = mapImage.clientHeight;
          if (originPxX === null || originPxY === null) return;
          // マイクラ座標→ピクセル座標（原点基準）
          const markerX = originPxX + (mx / getTotalBlocksX()) * imgW;
          const markerY = originPxY + (mz / getTotalBlocksY()) * imgH;
          const marker = document.createElement('div');
          marker.className = 'marker';
          marker.style.left = markerX + 'px';
          marker.style.top = markerY + 'px';
          marker.style.background = color;
          marker.setAttribute('data-title', title);
          marker.setAttribute('data-coordinates', JSON.stringify({x: mx, y: my, z: mz}));
          marker.setAttribute('data-image', imageUrl);
          marker.setAttribute('data-color', color);
          marker.setAttribute('data-memo', memo || '');
          marker.dataset.markerId = firebaseId || ('m' + (++markerIdSeq));
          marker.addEventListener('click', function(e) {
              if (!addMode && !originMode) {
                  e.stopPropagation();
                  toggleMarkerCard(this);
              }
          });
          mapContainer.appendChild(marker);
          markers.push(marker);
      }
      
      // 複数カードのトグル表示
      function toggleMarkerCard(marker) {
          const markerId = marker.dataset.markerId;
          const cardsContainer = document.getElementById('markerCards');
          let cardDiv = document.getElementById('markerCard-' + markerId);
          let lineSvg = document.getElementById('markerLine-' + markerId);
          if (cardDiv) {
              // 既に表示中→消す
              cardDiv.remove();
              if (lineSvg) lineSvg.remove();
              marker.classList.remove('active');
              return;
          }
          // 新規表示
          const title = marker.getAttribute('data-title');
          const coordinates = JSON.parse(marker.getAttribute('data-coordinates'));
          const imageUrl = marker.getAttribute('data-image');
          const color = marker.getAttribute('data-color') || '#ff4444';
          const imgW = mapImage.clientWidth;
          const imgH = mapImage.clientHeight;
          // マーカーのピクセル位置
          const mx = coordinates.x;
          const mz = coordinates.z;
          if (originPxX === null || originPxY === null) return;
          const markerX = originPxX + (mx / getTotalBlocksX()) * imgW;
          const markerY = originPxY + (mz / getTotalBlocksY()) * imgH;
          // カードの表示位置（右上にオフセット、はみ出し防止）
          const cardW = 200, cardH = 10, offset = 60;
          let cardLeft = markerX + offset;
          let cardTop = markerY - cardH/2;
          if (cardLeft + cardW > imgW) cardLeft = markerX - cardW - offset;
          if (cardTop < 0) cardTop = 0;
          if (cardTop + cardH > imgH) cardTop = imgH - cardH;
          // カード本体
          cardDiv = document.createElement('div');
          cardDiv.id = 'markerCard-' + markerId;
          cardDiv.style.position = 'absolute';
          cardDiv.style.left = cardLeft + 'px';
          cardDiv.style.top = cardTop + 'px';
          cardDiv.style.pointerEvents = 'auto';
          cardDiv.innerHTML = `
              <div style="background:#222;border-radius:10px;box-shadow:0 4px 16px #000;padding:14px 16px;width:${cardW}px;min-height:${cardH}px;display:flex;flex-direction:column;align-items:center;cursor:pointer;position:relative;">
                  <img src="${imageUrl}" style="max-width:220px;max-height:120px;border-radius:8px;box-shadow:0 2px 8px #000;margin-bottom:8px;">
                  <div style="color:#fff;font-size:17px;font-weight:bold;text-align:center;line-height:1.2;">${title}</div>
              </div>
          `;
          cardDiv.onclick = function(e) {
              e.stopPropagation();
              showModal(marker);
          };
          cardsContainer.appendChild(cardDiv);
          // 線SVG
          lineSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          lineSvg.setAttribute('id', 'markerLine-' + markerId);
          lineSvg.setAttribute('style', 'position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:20;');
          lineSvg.setAttribute('width', imgW);
          lineSvg.setAttribute('height', imgH);
          const lineStartX = cardLeft < markerX ? cardLeft + cardW : cardLeft;
          const lineStartY = cardTop + cardH/2;
          lineSvg.innerHTML = `<line x1="${lineStartX}" y1="${lineStartY}" x2="${markerX}" y2="${markerY}" stroke="${color}" stroke-width="3" />
              <circle cx="${markerX}" cy="${markerY}" r="6" fill="${color}" />`;
          cardsContainer.appendChild(lineSvg);
          marker.classList.add('active');
      }
      
      // 詳細モーダル（従来通り）
      function showModal(marker) {
          const title = marker.getAttribute('data-title');
          const coordinates = JSON.parse(marker.getAttribute('data-coordinates'));
          const imageUrl = marker.getAttribute('data-image');
          const memo = marker.getAttribute('data-memo') || '';
          const color = marker.getAttribute('data-color') || '#ff4444';
          document.getElementById('modalTitle').textContent = title;
          document.getElementById('modalCoordinates').textContent = 
              `座標: X=${coordinates.x}, Y=${coordinates.y}, Z=${coordinates.z}`;
          document.getElementById('modalImage').src = imageUrl;
          // メモ表示
          let memoElem = document.getElementById('modalMemo');
          if (!memoElem) {
              memoElem = document.createElement('div');
              memoElem.id = 'modalMemo';
              memoElem.style = 'margin: 12px 0; color: #fff; background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 6px; font-size: 15px; white-space: pre-wrap;';
              document.querySelector('.modal-body').appendChild(memoElem);
          }
          memoElem.textContent = memo ? `メモ: ${memo}` : '';
          // フッター生成・重複防止
          let footer = document.getElementById('modalFooter');
          if (footer) footer.remove();
          footer = document.createElement('div');
          footer.className = 'modal-footer';
          footer.id = 'modalFooter';
          footer.style.zIndex = 1100;
          document.querySelector('.modal-content').appendChild(footer);
          footer.innerHTML = `
              <button class="btn-edit" id="editMarkerBtn">編集</button>
              <button class="btn-danger" id="deleteMarkerBtn">削除</button>
          `;
          document.getElementById('deleteMarkerBtn').onclick = function() {
              if (confirm('このマーカーを削除しますか？')) {
                  marker.remove();
                  closeModal();
              }
          };
          document.getElementById('editMarkerBtn').onclick = function() {
              showEditMarkerDialog(marker);
          };
          document.getElementById('imageModal').style.display = 'block';
          // アクティブマーカーの表示
          markers.forEach(m => m.classList.remove('active'));
          marker.classList.add('active');
      }
      
      function closeModal() {
          document.getElementById('imageModal').style.display = 'none';
          markers.forEach(m => m.classList.remove('active'));
          hideAllMarkerCards();
      }
      
      function toggleAddMode() {
          addMode = !addMode;
          const btn = event.target;
          if (addMode) {
              btn.textContent = '❌ 追加モードを終了';
              btn.classList.add('btn-addmode-active');
              mapContainer.style.cursor = 'crosshair';
          } else {
              btn.textContent = '📍 マーカーを追加';
              btn.classList.remove('btn-addmode-active');
              mapContainer.style.cursor = 'default';
          }
      }
      
      function clearMarkers() {
          if (confirm('すべてのマーカーを削除しますか？')) {
              markers.forEach(marker => marker.remove());
              markers = [];
          }
      }
      
      function toggleOriginMode() {
          originMode = !originMode;
          const btn = document.getElementById('originBtn');
          if (originMode) {
              btn.textContent = '❌ 原点モード終了';
              btn.style.background = '#ff4444';
              mapContainer.style.cursor = 'crosshair';
          } else {
              btn.textContent = '🎯 原点を設定';
              btn.style.background = '#4CAF50';
              mapContainer.style.cursor = 'default';
          }
      }
      
      // モーダル外クリックで閉じる
      window.onclick = function(event) {
          const modal = document.getElementById('imageModal');
          if (event.target === modal) {
              closeModal();
          }
      }
      
      // ESCキーでモーダルを閉じる
      document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
              closeModal();
          }
      });
      
      // 編集ダイアログ
      function showEditMarkerDialog(marker) {
          const title = marker.getAttribute('data-title');
          const memo = marker.getAttribute('data-memo') || '';
          const coordinates = JSON.parse(marker.getAttribute('data-coordinates'));
          const imageUrl = marker.getAttribute('data-image');
          const color = marker.getAttribute('data-color') || '#ff4444';
          const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff', '#44ffff', '#ff8800', '#888888'];
          const dialog = document.createElement('div');
          dialog.style.position = 'fixed';
          dialog.style.left = '0';
          dialog.style.top = '0';
          dialog.style.width = '100vw';
          dialog.style.height = '100vh';
          dialog.style.background = 'rgba(0,0,0,0.7)';
          dialog.style.zIndex = '3000';
          dialog.style.display = 'flex';
          dialog.style.alignItems = 'center';
          dialog.style.justifyContent = 'center';
          dialog.innerHTML = `
              <div style="background:#222;padding:24px 32px;border-radius:12px;min-width:320px;max-width:90vw;box-shadow:0 0 24px #000;position:relative;">
                  <button id="closeEditMarker" style="position:absolute;top:8px;right:12px;font-size:20px;background:none;border:none;color:#fff;cursor:pointer;">&times;</button>
                  <h2 style="color:#4CAF50;margin-top:0;">マーカー編集</h2>
                  <label style="color:#fff;">座標 (x, y, z):<br>
                      <input id="editMarkerX" type="number" value="${coordinates.x}" style="width:70px;"> ,
                      <input id="editMarkerY" type="number" value="${coordinates.y}" style="width:70px;"> ,
                      <input id="editMarkerZ" type="number" value="${coordinates.z}" style="width:70px;">
                  </label><br><br>
                  <label style="color:#fff;">タイトル:<br>
                      <input id="editMarkerTitle" type="text" value="${title}" style="width:90%;">
                  </label><br><br>
                  <label style="color:#fff;">メモ:<br>
                      <textarea id="editMarkerMemo" rows="2" style="width:90%;resize:vertical;">${memo}</textarea>
                  </label><br><br>
                  <label style="color:#fff;">upload マップ:<br>
                      <input id="editMarkerImage" type="file" accept="image/*">
                  </label><br>
                  <img id="editMarkerPreview" src="${imageUrl}" style="max-width:200px;max-height:120px;margin:10px 0;display:block;">
                  <label style="color:#fff;">マーカー色:<br>
                      <div id="editColorChoices" style="display:flex;gap:8px;margin-top:4px;">
                          ${colors.map((c)=>`<div class=\"color-choice-edit\" data-color=\"${c}\" style=\"width:28px;height:28px;border-radius:50%;background:${c};border:3px solid #fff;cursor:pointer;box-shadow:0 2px 8px #000;${c===color?'outline:2px solid #4CAF50;':''}\"></div>`).join('')}
                      </div>
                  </label><br>
                  <button id="saveEditMarkerBtn" class="btn" style="margin-top:10px;">保存</button>
              </div>
          `;
          document.body.appendChild(dialog);
          // 色選択
          let selectedColor = color;
          dialog.querySelectorAll('.color-choice-edit').forEach(el => {
              el.onclick = function() {
                  dialog.querySelectorAll('.color-choice-edit').forEach(e=>e.style.outline='none');
                  this.style.outline = '2px solid #4CAF50';
                  selectedColor = this.getAttribute('data-color');
              };
          });
          // 画像プレビュー
          dialog.querySelector('#editMarkerImage').onchange = function(e) {
              if (e.target.files && e.target.files[0]) {
                  const reader = new FileReader();
                  reader.onload = function(ev) {
                      dialog.querySelector('#editMarkerPreview').src = ev.target.result;
                  };
                  reader.readAsDataURL(e.target.files[0]);
              }
          };
          dialog.querySelector('#closeEditMarker').onclick = ()=>dialog.remove();
          dialog.querySelector('#saveEditMarkerBtn').onclick = async function() {
              const newTitle = dialog.querySelector('#editMarkerTitle').value;
              const newMemo = dialog.querySelector('#editMarkerMemo').value;
              const newX = parseInt(dialog.querySelector('#editMarkerX').value);
              const newY = parseInt(dialog.querySelector('#editMarkerY').value);
              const newZ = parseInt(dialog.querySelector('#editMarkerZ').value);
              const fileInput = dialog.querySelector('#editMarkerImage');
              let imageFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
              const markerId = marker.dataset.markerId;
              const markerData = {
                  x: newX, y: newY, z: newZ,
                  title: newTitle,
                  memo: newMemo,
                  color: selectedColor,
                  imageUrl: marker.getAttribute('data-image')
              };
              await window.updateMarkerInFirebase(markerId, markerData, imageFile);
              dialog.remove();
              closeModal();
              window.renderAllMarkers();
          };
      }
      
      function toggleInfo() {
          const ul = document.getElementById('infoList');
          const icon = document.getElementById('infoToggleIcon');
          if (ul.style.display === 'none') {
              ul.style.display = '';
              icon.textContent = '▼';
          } else {
              ul.style.display = 'none';
              icon.textContent = '▼';
          }
      }
      
      // マップ分割数設定の反映
      function applyMapGrid() {
          const cols = parseInt(document.getElementById('mapCols').value);
          const rows = parseInt(document.getElementById('mapRows').value);
          if (isNaN(cols) || isNaN(rows) || cols < 1 || rows < 1) {
              alert('マップ枚数は1以上の整数で指定してください');
              return;
          }
          mapCols = cols;
          mapRows = rows;
          localStorage.setItem('mapCols', mapCols);
          localStorage.setItem('mapRows', mapRows);
          // 既存マーカーの再配置
          updateAllMarkerPositions();
      }
      
      // 既存マーカーの再配置
      function updateAllMarkerPositions() {
          const imgW = mapImage.clientWidth;
          const imgH = mapImage.clientHeight;
          markers.forEach(marker => {
              const coordinates = JSON.parse(marker.getAttribute('data-coordinates'));
              const mx = coordinates.x;
              const mz = coordinates.z;
              if (originPxX === null || originPxY === null) return;
              const markerX = originPxX + (mx / getTotalBlocksX()) * imgW;
              const markerY = originPxY + (mz / getTotalBlocksY()) * imgH;
              marker.style.left = markerX + 'px';
              marker.style.top = markerY + 'px';
          });
      }
      
      // カード/モーダル以外クリックで全カード非表示
      mapContainer.addEventListener('click', function(e) {
          if (e.target.classList.contains('marker')) return;
          hideAllMarkerCards();
      });

      function hideAllMarkerCards() {
          const cardsContainer = document.getElementById('markerCards');
          cardsContainer.innerHTML = '';
          markers.forEach(m => m.classList.remove('active'));
      }
      
      // 初期化とマーカー描画をDOMContentLoadedで実行
      window.addEventListener('DOMContentLoaded', async () => {
          // Firestoreから原点を取得してセット
          const origin = await loadOriginFromFirebase();
          if (origin) {
              originPxX = origin.originPxX;
              originPxY = origin.originPxY;
          }
          init();
          renderAllMarkers();
          document.getElementById('originBtn').addEventListener('click', toggleOriginMode);
          document.querySelector('.btn-marker-add').addEventListener('click', toggleAddMode);
          document.querySelector('.btn-marker-clear').addEventListener('click', clearMarkers);
      });

      // マップ画像アップロード
      document.getElementById('mapImageUpload').addEventListener('change', function(e) {
          if (e.target.files && e.target.files[0]) {
              const reader = new FileReader();
              reader.onload = function(ev) {
                  mapImage.src = ev.target.result;
              };
              reader.readAsDataURL(e.target.files[0]);
          }
      });

      // Firebase関数をwindowにエクスポート（編集・追加で使う）
      window.saveMarkerToFirebase = saveMarkerToFirebase;
      window.loadMarkersFromFirebase = loadMarkersFromFirebase;
      window.updateMarkerInFirebase = updateMarkerInFirebase;
      window.renderAllMarkers = renderAllMarkers;
    </script>
</body>
</html>
